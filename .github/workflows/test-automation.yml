name: Test Automation CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - regression
          - api-only
          - ui-only

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  api-tests:
    name: API Test Suite
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [ '17' ]

    steps:
      # ==========================================
      # STEP 1: Checkout Repository
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================
      # STEP 2: Setup Java Environment
      # ==========================================
      - name: Setup Java JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      # ==========================================
      # STEP 3: Verify Java Installation
      # ==========================================
      - name: Verify Java installation
        run: |
          java -version
          mvn -version

      # ==========================================
      # STEP 4: Cache Maven Dependencies
      # ==========================================
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ==========================================
      # STEP 5: Install Dependencies
      # ==========================================
      - name: Install project dependencies
        run: mvn clean install -DskipTests

      # ==========================================
      # STEP 6: Run API Tests with Mock Server
      # ==========================================
      - name: Execute API test suite
        env:
          MOCK_API: "true"  # Enable WireMock mock server to bypass Cloudflare protection
          TESTRAIL_ENABLED: "true"  # Enable TestRail result reporting
          TESTRAIL_URL: ${{ secrets.TESTRAIL_URL }}
          TESTRAIL_USERNAME: ${{ secrets.TESTRAIL_USERNAME }}
          TESTRAIL_API_KEY: ${{ secrets.TESTRAIL_API_KEY }}
          TESTRAIL_PROJECT_ID: ${{ secrets.TESTRAIL_PROJECT_ID }}
        run: |
          echo "ðŸš€ Running API tests with WireMock mock server (Cloudflare bypass)"
          echo "ðŸ“Š TestRail reporting enabled"
          if [[ "${{ github.event.inputs.test_suite }}" == "smoke" ]]; then
            echo "Running smoke tests..."
            mvn clean test -Psmoke
          elif [[ "${{ github.event.inputs.test_suite }}" == "regression" ]]; then
            echo "Running regression tests..."
            mvn clean test -Pregression
          elif [[ "${{ github.event.inputs.test_suite }}" == "api-only" ]]; then
            echo "Running API tests only..."
            mvn test -Dtest=ApiTestRunner
          elif [[ "${{ github.event.inputs.test_suite }}" == "ui-only" ]]; then
            echo "Skipping API tests (UI only mode)..."
            exit 0
          else
            echo "Running API tests (default)..."
            mvn test -Dtest=ApiTestRunner
          fi

      # NOTE: WireMock mock server is used in CI/CD to bypass Cloudflare protection.
      # Local execution uses real FakeStoreAPI (MOCK_API not set or set to false).
      # Mock server provides identical API responses to ensure tests validate the
      # same behavior in both environments.

      # ==========================================
      # STEP 7: Upload Cucumber HTML Reports
      # ==========================================
      - name: Upload Cucumber HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-html-report
          path: target/cucumber-reports/api/cucumber.html
          retention-days: 30

      # ==========================================
      # STEP 8: Upload Cucumber JSON Reports
      # ==========================================
      - name: Upload Cucumber JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-json-report
          path: target/cucumber-reports/api/cucumber.json
          retention-days: 30

      # ==========================================
      # STEP 9: Upload JUnit XML Reports
      # ==========================================
      - name: Upload JUnit XML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-xml-report
          path: target/cucumber-reports/api/cucumber.xml
          retention-days: 30

      # ==========================================
      # STEP 10: Upload Maven Surefire Reports
      # ==========================================
      - name: Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 30

      # ==========================================
      # STEP 11: Upload Test Logs
      # ==========================================
      - name: Upload test execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: logs/
          retention-days: 7

      # ==========================================
      # STEP 12: Publish Test Results Summary
      # ==========================================
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            target/cucumber-reports/api/cucumber.xml
            target/surefire-reports/*.xml
          check_name: API Test Results
          comment_title: Test Execution Summary

      # ==========================================
      # STEP 13: Generate Test Summary
      # ==========================================
      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Java Version**: ${{ matrix.java }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed test reports." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Cucumber HTML Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Cucumber JSON Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ JUnit XML Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Surefire Reports" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªµ Test Execution Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Known CI Limitation" >> $GITHUB_STEP_SUMMARY
          echo "**API Tests:** FakeStoreAPI uses Cloudflare bot protection that blocks GitHub Actions IP ranges." >> $GITHUB_STEP_SUMMARY
          echo "**Local Execution:** All 9/9 API scenarios pass successfully when run locally." >> $GITHUB_STEP_SUMMARY
          echo "**Root Cause:** Cloudflare's managed challenge mode blocks cloud provider IPs regardless of browser headers." >> $GITHUB_STEP_SUMMARY
          echo "**Evidence:** See local test execution screenshots and video recordings in repository documentation." >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job: Build Verification
  # ==========================================
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Verify project builds
        run: mvn clean compile

      - name: Run dependency checks
        run: mvn dependency:tree

      - name: Display project info
        run: |
          echo "Project: $(mvn help:evaluate -Dexpression=project.name -q -DforceStdout)"
          echo "Version: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"
          echo "Group: $(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)"

  # ==========================================
  # Job: UI Test Suite
  # ==========================================
  ui-tests:
    name: UI Test Suite (Playwright)
    runs-on: ubuntu-22.04  # Using 22.04 for stable Playwright dependencies

    strategy:
      matrix:
        java: [ '17' ]

    steps:
      # ==========================================
      # STEP 1: Checkout Repository
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================
      # STEP 2: Setup Java Environment
      # ==========================================
      - name: Setup Java JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      # ==========================================
      # STEP 3: Install Playwright Browsers
      # ==========================================
      - name: Install Playwright browsers
        run: |
          echo "Installing Playwright Chromium with system dependencies..."
          mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install --with-deps chromium"
          echo "Playwright installation completed successfully"

      # ==========================================
      # STEP 4: Cache Maven Dependencies
      # ==========================================
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ==========================================
      # STEP 5: Install Dependencies
      # ==========================================
      - name: Install project dependencies
        run: mvn clean install -DskipTests

      # ==========================================
      # STEP 6: Run UI Tests
      # ==========================================
      - name: Execute UI test suite
        run: |
          if [[ "${{ github.event.inputs.test_suite }}" == "smoke" ]]; then
            echo "Running smoke tests..."
            mvn clean test -Psmoke
          elif [[ "${{ github.event.inputs.test_suite }}" == "regression" ]]; then
            echo "Running regression tests..."
            mvn clean test -Pregression
          elif [[ "${{ github.event.inputs.test_suite }}" == "ui-only" ]]; then
            echo "Running UI tests only..."
            mvn test -Dtest=UiTestRunner
          elif [[ "${{ github.event.inputs.test_suite }}" == "api-only" ]]; then
            echo "Skipping UI tests (API only mode)..."
            exit 0
          else
            echo "Running UI tests (default)..."
            mvn test -Dtest=UiTestRunner
          fi
        continue-on-error: false

      # ==========================================
      # STEP 7: Upload Cucumber HTML Reports
      # ==========================================
      - name: Upload UI Cucumber HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-cucumber-html-report
          path: target/cucumber-reports/ui/cucumber.html
          retention-days: 30

      # ==========================================
      # STEP 8: Upload Cucumber JSON Reports
      # ==========================================
      - name: Upload UI Cucumber JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-cucumber-json-report
          path: target/cucumber-reports/ui/cucumber.json
          retention-days: 30

      # ==========================================
      # STEP 9: Upload JUnit XML Reports
      # ==========================================
      - name: Upload UI JUnit XML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-junit-xml-report
          path: target/cucumber-reports/ui/cucumber.xml
          retention-days: 30

      # ==========================================
      # STEP 10: Upload Screenshots (if any)
      # ==========================================
      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ui-failure-screenshots
          path: target/screenshots/
          retention-days: 7

      # ==========================================
      # STEP 11: Publish Test Results Summary
      # ==========================================
      - name: Publish UI test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: target/cucumber-reports/ui/cucumber.xml
          check_name: UI Test Results
          comment_title: UI Test Execution Summary
